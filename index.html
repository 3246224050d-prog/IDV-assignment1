import requests
import json
from datetime import datetime

def get_psi_data():
    """
    从 data.gov.sg API 获取 PSI 数据
    """
    url = "https://api.data.gov.sg/v1/environment/psi"
    
    try:
        response = requests.get(url)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"获取数据时出错: {e}")
        return None

def print_table(headers, data):
    """
    打印表格的简单实现
    """
    # 计算每列的最大宽度
    col_widths = []
    for i in range(len(headers)):
        max_width = len(str(headers[i]))
        for row in data:
            if i < len(row):
                max_width = max(max_width, len(str(row[i])))
        col_widths.append(max_width + 2)  # 加2为了留出空格
    
    # 打印表头
    header_line = ""
    for i, header in enumerate(headers):
        header_line += str(header).ljust(col_widths[i])
    print(header_line)
    print("-" * len(header_line))
    
    # 打印数据行
    for row in data:
        row_line = ""
        for i, cell in enumerate(row):
            row_line += str(cell).ljust(col_widths[i])
        print(row_line)

def print_readings_table_simple(data):
    """
    使用简单表格打印读数数据
    """
    if not data or 'items' not in data or not data['items']:
        print("未找到有效数据")
        return
    
    item = data['items'][0]
    readings = item.get('readings', {})
    
    if not readings:
        print("未找到读数数据")
        return
    
    reading_types = [
        'o3_sub_index',
        'o3_eight_hour_max', 
        'co_sub_index',
        'co_eight_hour_max',
        'pm10_sub_index',
        'pm10_twenty_four_hourly',
        'so2_sub_index',
        'so2_twenty_four_hourly',
        'no2_one_hour_max',
        'pm25_sub_index',
        'pm25_twenty_four_hourly',
        'psi_twenty_four_hourly'
    ]
    
    regions = ['national', 'east', 'central', 'west', 'north', 'south']
    
    # 准备表格数据
    headers = ['Reading Type'] + [region.title() for region in regions]
    table_data = []
    
    for reading_type in reading_types:
        if reading_type in readings:
            row = [reading_type.replace('_', ' ').title()]
            for region in regions:
                if region in readings[reading_type]:
                    row.append(readings[reading_type][region])
                else:
                    row.append('N/A')
            table_data.append(row)
    
    print("\n" + "="*80)
    print("PSI READINGS DATA")
    print("="*80)
    print_table(headers, table_data)
    
    # 显示更新时间
    timestamp = item.get('timestamp', '')
    if timestamp:
        dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
        print(f"\n数据更新时间: {dt.strftime('%Y-%m-%d %H:%M:%S')}")

def main():
    """
    主函数
    """
    print("正在从 data.gov.sg 获取 PSI 数据...")
    
    data = get_psi_data()
    
    if data:
        print_readings_table_simple(data)
    else:
        print("无法获取数据，请检查网络连接或API状态")

if __name__ == "__main__":
    main()
